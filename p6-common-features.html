<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Common Features â€” RFT Program 6</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    @keyframes pop { 0%{transform:scale(1)} 50%{transform:scale(1.15)} 100%{transform:scale(1)} }
    @keyframes wiggle { 0%,100%{transform:rotate(0)} 25%{transform:rotate(-5deg)} 75%{transform:rotate(5deg)} }
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
    @keyframes slideUp { 0%{opacity:0;transform:translateY(16px)} 100%{opacity:1;transform:translateY(0)} }
    @keyframes snap { 0%{transform:scale(0.8) translateY(10px);opacity:0} 60%{transform:scale(1.1) translateY(-2px);opacity:1} 100%{transform:scale(1) translateY(0);opacity:1} }
    @keyframes featureGlow { 0%,100%{filter:brightness(1)} 50%{filter:brightness(1.3) drop-shadow(0 0 8px currentColor)} }
    .anim-pop { animation: pop 0.3s ease-in-out; }
    .anim-wiggle { animation: wiggle 0.4s ease-in-out; }
    .anim-float { animation: float 3s ease-in-out infinite; }
    .anim-slideup { animation: slideUp 0.3s ease-out; }
    .anim-snap { animation: snap 0.4s ease-out; }
    .anim-glow { animation: featureGlow 1.5s ease-in-out 2; }
    .fredoka { font-family: 'Fredoka', sans-serif; }
    .nunito { font-family: 'Nunito', sans-serif; }
    .safari {
      background: linear-gradient(180deg, #FEF3C7 0%, #FDE68A 30%, #D9F99D 60%, #A7F3D0 100%);
    }
    .card-shadow { box-shadow: 2px 4px 12px rgba(0,0,0,0.12), 0 1px 3px rgba(0,0,0,0.06); }
  
    .frameshift-back {
      position: fixed; top: 12px; left: 12px; z-index: 50;
      background: rgba(255,255,255,0.85); backdrop-filter: blur(8px);
      border: 1px solid rgba(0,0,0,0.1); border-radius: 12px;
      padding: 6px 14px; font-family: 'Fredoka', sans-serif;
      font-size: 13px; font-weight: 600; color: #6366F1;
      text-decoration: none; transition: all 0.2s;
      box-shadow: 1px 2px 6px rgba(0,0,0,0.08);
    }
    .frameshift-back:hover { background: rgba(255,255,255,0.95); transform: scale(1.05); color: #4F46E5; }
  </style>

  <!-- FrameShift Tracker Integration -->
  <script>
    window.FrameShift = {
      STORAGE_KEY: "frameshift_progress",
      load: function() {
        try {
          var raw = localStorage.getItem(this.STORAGE_KEY);
          return raw ? JSON.parse(raw) : { programs: {}, achievements: {}, totalSessions: 0, streak: { current: 0, best: 0, lastDate: null } };
        } catch(e) { return { programs: {}, achievements: {}, totalSessions: 0, streak: { current: 0, best: 0, lastDate: null } }; }
      },
      save: function(data) {
        try { localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data)); } catch(e) {}
      },
      saveSession: function(programId, trainScore, trainMax, testScore, testMax, mastery) {
        var data = this.load();
        if (!data.programs[programId]) {
          data.programs[programId] = { sessions: [], bestScore: { train: 0, test: null }, mastery: false, lastPlayed: null };
        }
        var prog = data.programs[programId];
        var session = { date: new Date().toISOString(), trainScore: trainScore, trainMax: trainMax };
        if (testScore !== undefined && testScore !== null) {
          session.testScore = testScore;
          session.testMax = testMax;
        }
        prog.sessions.push(session);
        prog.lastPlayed = new Date().toISOString();
        if (trainScore > prog.bestScore.train) prog.bestScore.train = trainScore;
        if (testScore !== undefined && testScore !== null && (prog.bestScore.test === null || testScore > prog.bestScore.test)) {
          prog.bestScore.test = testScore;
        }
        if (mastery) prog.mastery = true;
        data.totalSessions++;
        // Streak tracking
        var today = new Date().toISOString().split('T')[0];
        if (data.streak.lastDate) {
          var last = new Date(data.streak.lastDate);
          var diff = Math.floor((new Date(today) - last) / 86400000);
          if (diff === 1) { data.streak.current++; }
          else if (diff > 1) { data.streak.current = 1; }
        } else { data.streak.current = 1; }
        data.streak.lastDate = today;
        if (data.streak.current > data.streak.best) data.streak.best = data.streak.current;
        this.save(data);
        return data;
      }
    };
  </script>

</head>
<body>
  <a href="index.html" class="frameshift-back">â† FrameShift</a>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const TRIALS_PER_PHASE = 9; // 3 classes Ã— 3 reps
    const MASTERY_THRESHOLD = 8;
    const emojiURL = (code) => `https://openmoji.org/data/color/svg/${code}.svg`;

    const PHASES = {
      BA: { label: "What Do They Have? (Set 1)", relation: "B-A", isTrain: true },
      CA: { label: "What Do They Have? (Set 2)", relation: "C-A", isTrain: true },
      CB: { label: "What's in Common? (Test)", relation: "C-B", isTrain: false },
    };

    // â”€â”€ FEATURE CLASSES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Tier 1: Visually obvious, maximally distinct features
    const FEATURE_CLASSES = [
      {
        id: 1,
        feature: { label: "Stripes", color: "#F59E0B" },
        animalB: { label: "Tiger",     emoji: "1F42F" },
        animalC: { label: "Zebra",     emoji: "1F993" },
      },
      {
        id: 2,
        feature: { label: "Spikes", color: "#8B5CF6" },
        animalB: { label: "Porcupine", emoji: "1F994" }, // hedgehog emoji (closest)
        animalC: { label: "Hedgehog",  emoji: "1F994" }, // same emoji, different label
      },
      {
        id: 3,
        feature: { label: "Scales", color: "#06B6D4" },
        animalB: { label: "Snake",     emoji: "1F40D" },
        animalC: { label: "Fish",      emoji: "1F41F" },
      },
    ];

    // For Porcupine we use a simple inline SVG to differentiate from Hedgehog
    const PorcupineSVG = ({ size = 80 }) => (
      <svg width={size} height={size} viewBox="0 0 80 80">
        {/* Body */}
        <ellipse cx="40" cy="48" rx="26" ry="20" fill="#8B6914"/>
        {/* Spikes */}
        {[-50,-35,-20,-5,10,25,40].map((angle,i) => (
          <line key={i} x1="40" y1="30"
            x2={40 + 28*Math.cos((angle-90)*Math.PI/180)}
            y2={30 + 28*Math.sin((angle-90)*Math.PI/180)}
            stroke="#5C4813" strokeWidth="3" strokeLinecap="round"/>
        ))}
        {/* Face */}
        <ellipse cx="30" cy="44" rx="8" ry="6" fill="#C4A43C"/>
        <circle cx="27" cy="42" r="2" fill="#1E1E1E"/>
        <ellipse cx="23" cy="46" rx="3" ry="2" fill="#333"/>
        {/* Feet */}
        <ellipse cx="28" cy="65" rx="5" ry="3" fill="#6B5216"/>
        <ellipse cx="50" cy="65" rx="5" ry="3" fill="#6B5216"/>
      </svg>
    );

    // â”€â”€ SOUNDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const useSound = () => {
      const ctxRef = useRef(null);
      const getCtx = () => {
        if (!ctxRef.current) ctxRef.current = new (window.AudioContext || window.webkitAudioContext)();
        return ctxRef.current;
      };
      const playCorrect = () => {
        const ctx = getCtx(), now = ctx.currentTime;
        // Satisfying "snap" â€” feature sticks!
        [440, 660, 880].forEach((f, i) => {
          const o = ctx.createOscillator(), g = ctx.createGain();
          o.connect(g); g.connect(ctx.destination);
          o.frequency.value = f; o.type = "sine";
          g.gain.setValueAtTime(0.22, now + i * 0.08);
          g.gain.exponentialRampToValueAtTime(0.01, now + i * 0.08 + 0.25);
          o.start(now + i * 0.08); o.stop(now + i * 0.08 + 0.3);
        });
      };
      const playWrong = () => {
        const ctx = getCtx(), now = ctx.currentTime;
        const o = ctx.createOscillator(), g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        o.type = "sine"; o.frequency.setValueAtTime(260, now);
        o.frequency.linearRampToValueAtTime(200, now + 0.25);
        g.gain.setValueAtTime(0.12, now);
        g.gain.linearRampToValueAtTime(0.01, now + 0.35);
        o.start(now); o.stop(now + 0.4);
      };
      const playNeutral = () => {
        const ctx = getCtx(), now = ctx.currentTime;
        const o = ctx.createOscillator(), g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        o.frequency.value = 440; o.type = "sine";
        g.gain.setValueAtTime(0.1, now);
        g.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
        o.start(now); o.stop(now + 0.25);
      };
      const playComplete = () => {
        const ctx = getCtx(), now = ctx.currentTime;
        [392, 494, 587, 659, 784].forEach((f, i) => {
          const o = ctx.createOscillator(), g = ctx.createGain();
          o.connect(g); g.connect(ctx.destination);
          o.frequency.value = f; o.type = "triangle";
          g.gain.setValueAtTime(0.18, now + i * 0.1);
          g.gain.exponentialRampToValueAtTime(0.01, now + i * 0.1 + 0.3);
          o.start(now + i * 0.1); o.stop(now + i * 0.1 + 0.35);
        });
      };
      return { playCorrect, playWrong, playNeutral, playComplete };
    };

    // â”€â”€ ANIMAL IMAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const AnimalImg = ({ animal, size = 80, className = "" }) => {
      // Special handling for Porcupine (differentiate from hedgehog)
      if (animal.label === "Porcupine") return <div className={className}><PorcupineSVG size={size} /></div>;
      return (
        <div className={className}>
          <img src={emojiURL(animal.emoji)} alt={animal.label}
            width={size} height={size} style={{width:size,height:size}} draggable={false} />
        </div>
      );
    };

    // â”€â”€ TRIAL GENERATORS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const generateTrainTrials = (animalKey, count) => {
      // animalKey: "animalB" or "animalC"
      const trials = [];
      const reps = Math.ceil(count / FEATURE_CLASSES.length);
      const pool = [];
      for (let r = 0; r < reps; r++) FEATURE_CLASSES.forEach(c => pool.push(c));
      for (let i = pool.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [pool[i], pool[j]] = [pool[j], pool[i]];
      }
      pool.slice(0, count).forEach(target => {
        const options = [...FEATURE_CLASSES].sort(() => Math.random() - 0.5);
        const correctIndex = options.findIndex(c => c.id === target.id);
        trials.push({
          animal: target[animalKey],
          feature: target.feature,
          options: options.map(c => c.feature),
          correctIndex,
          targetClass: target,
          type: "train",
        });
      });
      return trials;
    };

    const generateTestTrials = (count) => {
      // TEST Câ†’B: show C animal, pick B animal that shares feature
      const trials = [];
      const reps = Math.ceil(count / FEATURE_CLASSES.length);
      const pool = [];
      for (let r = 0; r < reps; r++) FEATURE_CLASSES.forEach(c => pool.push(c));
      for (let i = pool.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [pool[i], pool[j]] = [pool[j], pool[i]];
      }
      pool.slice(0, count).forEach(target => {
        const options = [...FEATURE_CLASSES].sort(() => Math.random() - 0.5);
        const correctIndex = options.findIndex(c => c.id === target.id);
        trials.push({
          animalC: target.animalC,
          options: options.map(c => c.animalB),
          correctIndex,
          targetClass: target,
          type: "test",
        });
      });
      return trials;
    };

    // â”€â”€ FEATURE BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const FeatureButton = ({ feature, index, selected, feedback, isCorrect, disabled, onClick }) => {
      let border = "border-gray-200"; let bg = "bg-white"; let anim = "";
      if (selected && feedback === "correct") { border="border-green-400"; bg="bg-green-50"; anim="anim-snap"; }
      else if (selected && feedback === "wrong") { border="border-red-300"; bg="bg-red-50"; anim="anim-wiggle"; }
      else if (!selected && feedback && isCorrect) { border="border-green-300"; bg="bg-green-50"; }
      else if (selected && !feedback) { border="border-amber-400"; bg="bg-amber-50"; }

      return (
        <button onClick={() => onClick(index)} disabled={disabled}
          className={`rounded-2xl border-3 ${border} ${bg} card-shadow px-6 py-3
            transition-all duration-200 ${!disabled?"hover:scale-105 cursor-pointer":"cursor-default"} relative`}
          style={{borderWidth:3}}>
          <div className={anim} onAnimationEnd={e=>e.currentTarget.className=""}>
            <span className="fredoka text-xl font-bold" style={{color: feature.color}}>
              {feature.label}
            </span>
          </div>
          {feedback && isCorrect && <span className="absolute -top-2 -right-2 bg-green-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold shadow">âœ“</span>}
          {selected && feedback === "wrong" && <span className="absolute -top-2 -right-2 bg-red-400 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold shadow">âœ—</span>}
        </button>
      );
    };

    // â”€â”€ ANIMAL CARD (for test phase) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const AnimalCard = ({ animal, index, selected, feedback, isCorrect, disabled, onClick }) => {
      let border = "border-green-100"; let bg = "bg-white"; let anim = "";
      if (selected) { border="border-amber-300"; bg="bg-amber-50"; }
      // In test phase: no feedback highlighting â€” neutral
      return (
        <button onClick={() => onClick(index)} disabled={disabled}
          className={`rounded-2xl border-3 ${border} ${bg} card-shadow p-4
            transition-all duration-200 ${!disabled?"hover:scale-105 cursor-pointer":"cursor-default"}
            flex flex-col items-center gap-1 min-w-[100px] relative`}
          style={{borderWidth:3}}>
          <AnimalImg animal={animal} size={64} />
          <span className="nunito text-sm text-gray-700 font-semibold">{animal.label}</span>
        </button>
      );
    };

    // â”€â”€ MAIN GAME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const CommonFeatures = () => {
      const [currentPhase, setCurrentPhase] = useState("BA");
      const [trials, setTrials] = useState([]);
      const [trialIndex, setTrialIndex] = useState(0);
      const [selected, setSelected] = useState(null);
      const [feedback, setFeedback] = useState(null);
      const [score, setScore] = useState(0);
      const [phaseScores, setPhaseScores] = useState({ BA: null, CA: null, CB: null });
      const [sessionDone, setSessionDone] = useState(false);
      const [trialLog, setTrialLog] = useState([]);
      const [featureAttached, setFeatureAttached] = useState(false); // animation state
      const { playCorrect, playWrong, playNeutral, playComplete } = useSound();

      const startPhase = (phase) => {
        if (phase === "BA") setTrials(generateTrainTrials("animalB", TRIALS_PER_PHASE));
        else if (phase === "CA") setTrials(generateTrainTrials("animalC", TRIALS_PER_PHASE));
        else setTrials(generateTestTrials(TRIALS_PER_PHASE));
        setTrialIndex(0); setSelected(null); setFeedback(null); setScore(0);
        setFeatureAttached(false);
      };

      useEffect(() => { startPhase("BA"); }, []);

      const handleSelect = (index) => {
        if (feedback !== null) return;
        setSelected(index);
      };

      const handleSubmit = () => {
        if (selected === null || feedback !== null) return;
        const trial = trials[trialIndex];
        const isCorrect = selected === trial.correctIndex;
        const isTest = currentPhase === "CB";

        // Log with diagnostic detail
        const logEntry = {
          trial_number: trialLog.length + 1,
          phase: isTest ? "TEST" : "TRAIN",
          relation_type: PHASES[currentPhase].relation,
          stimulus: trial.type === "train" ? trial.animal.label : trial.animalC.label,
          response: trial.type === "train"
            ? trial.options[selected].label
            : trial.options[selected].label,
          correct_response: trial.type === "train"
            ? trial.options[trial.correctIndex].label
            : trial.options[trial.correctIndex].label,
          is_correct: isCorrect,
          feature_class: trial.targetClass.feature.label,
          // Diagnostic: what kind of error?
          error_type: isCorrect ? null : (
            trial.type === "test" ? "wrong_animal" : "wrong_feature"
          ),
          wrong_answer_feature: !isCorrect && trial.type === "test"
            ? FEATURE_CLASSES.find(c => c.animalB.label === trial.options[selected].label)?.feature.label
            : null,
          timestamp: new Date().toISOString(),
        };
        setTrialLog(prev => [...prev, logEntry]);

        if (isTest) {
          // Test phase: neutral sound, no corrective feedback
          playNeutral();
          setFeedback("recorded");
          setScore(s => s + (isCorrect ? 1 : 0));
        } else if (isCorrect) {
          playCorrect();
          setScore(s => s + 1);
          setFeedback("correct");
          setFeatureAttached(true);
        } else {
          playWrong();
          setFeedback("wrong");
        }
      };

      const handleNext = () => {
        if (trialIndex + 1 >= TRIALS_PER_PHASE) {
          setPhaseScores(prev => ({ ...prev, [currentPhase]: score }));
          if (currentPhase === "BA" && score >= MASTERY_THRESHOLD - 1) {
            setCurrentPhase("CA"); startPhase("CA"); return;
          } else if (currentPhase === "CA" && score >= MASTERY_THRESHOLD - 1) {
            setCurrentPhase("CB"); startPhase("CB"); return;
          }
          
            // â”€â”€ FrameShift Tracker Save â”€â”€
            if (window.FrameShift) {
              window.FrameShift.saveSession(
                "p6",
                phaseScores.CA !== null ? phaseScores.CA : (score || 0),
                9,
                phaseScores.CB !== null ? phaseScores.CB : null,
                9,
                phaseScores.CB !== null
              );
            }
            setSessionDone(true);
          setTimeout(playComplete, 200);
          return;
        }
        setTrialIndex(i => i + 1);
        setSelected(null); setFeedback(null); setFeatureAttached(false);
      };

      const handleRestart = () => {
        setCurrentPhase("BA"); startPhase("BA");
        setPhaseScores({ BA: null, CA: null, CB: null });
        setSessionDone(false); setTrialLog([]);
      };

      if (trials.length === 0) return (
        <div className="min-h-screen safari flex items-center justify-center">
          <div className="text-green-800 text-2xl fredoka">Setting up safari...</div>
        </div>
      );

      // â”€â”€ SESSION COMPLETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if (sessionDone) {
        const allPhases = phaseScores.CB !== null;
        return (
          <div className="min-h-screen safari p-4 sm:p-8">
            <div className="max-w-lg mx-auto mt-12">
              <div className="bg-white bg-opacity-95 rounded-3xl p-8 sm:p-12 card-shadow text-center border-2 border-green-300">
                <div className="text-6xl mb-4 anim-float">{allPhases ? "ğŸ¦" : "ğŸŒ¿"}</div>
                <h2 className="text-4xl fredoka text-green-800 mb-4">
                  {allPhases ? "Feature Detective!" : "Good Exploring!"}
                </h2>
                <div className="space-y-3 mb-6 text-left max-w-xs mx-auto">
                  {Object.entries(phaseScores).map(([ph, sc]) => (
                    sc !== null && (
                      <div key={ph} className="flex justify-between nunito">
                        <span className="text-green-700 font-semibold">{PHASES[ph].label}</span>
                        <span className={`font-bold ${sc >= MASTERY_THRESHOLD - 1 ? "text-green-600" : "text-amber-600"}`}>
                          {sc}/{TRIALS_PER_PHASE} {sc >= MASTERY_THRESHOLD - 1 ? "âœ“" : ""}
                        </span>
                      </div>
                    )
                  ))}
                </div>
                {allPhases && phaseScores.CB >= MASTERY_THRESHOLD - 1 && (
                  <p className="text-green-600 nunito mb-6">
                    ğŸ¯ Analogical reasoning emerged! Shared features link animals that were never paired directly.
                  </p>
                )}
                <button onClick={handleRestart}
                  className="px-8 py-4 rounded-2xl font-bold text-lg bg-gradient-to-b from-green-400 to-green-600 text-white hover:from-green-300 hover:to-green-500 shadow-lg hover:scale-105 transition-all fredoka border-2 border-green-700">
                  ğŸŒ¿ Explore Again
                </button>
                <div style={{marginTop: "12px"}}>
                  <a href="index.html" className="inline-block px-6 py-2 rounded-xl nunito text-sm font-semibold text-indigo-500 hover:text-indigo-700 hover:bg-indigo-50 transition-all border border-indigo-200">
                    â† Back to FrameShift
                  </a>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // â”€â”€ MAIN TRIAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const trial = trials[trialIndex];
      const isTest = currentPhase === "CB";

      return (
        <div className="min-h-screen safari p-4 sm:p-8">
          <div className="max-w-2xl mx-auto">
            {/* Header */}
            <div className="text-center mb-3">
              <h1 className="text-4xl sm:text-5xl fredoka text-green-900 drop-shadow-sm mb-1 anim-float">
                ğŸŒ¿ Common Features ğŸŒ¿
              </h1>
              <p className="text-green-700 nunito opacity-60 text-sm">
                RFT Program 6 Â· Analogical Reasoning
              </p>
            </div>

            {/* Phase tabs */}
            <div className="flex gap-2 justify-center mb-4 flex-wrap">
              {["BA","CA","CB"].map(p => (
                <div key={p} className={`px-3 py-1.5 rounded-xl text-sm font-semibold nunito transition-all
                  ${p === currentPhase ? "bg-green-600 text-white shadow-md" :
                    phaseScores[p] !== null ? "bg-green-100 text-green-700 border border-green-300" :
                    "bg-gray-100 text-gray-400 border border-gray-200"}`}>
                  {phaseScores[p] !== null && "âœ“ "}{PHASES[p].label}
                </div>
              ))}
            </div>

            {/* Progress */}
            <div className="flex justify-between text-sm nunito text-green-700 mb-1 px-1">
              <span>Trial {trialIndex + 1} of {TRIALS_PER_PHASE}</span>
              <span>{score} correct</span>
            </div>
            <div className="w-full bg-green-100 rounded-full h-3 mb-6 overflow-hidden border border-green-200">
              <div className="h-full rounded-full transition-all duration-500 bg-gradient-to-r from-green-400 to-emerald-500"
                style={{ width: `${(trialIndex / TRIALS_PER_PHASE) * 100}%` }} />
            </div>

            {/* â”€â”€ TRAIN PHASES: Animal â†’ Feature â”€â”€ */}
            {!isTest && (
              <>
                {/* Show animal */}
                <div className="text-center mb-4 anim-slideup">
                  <div className="inline-flex flex-col items-center gap-2 bg-white bg-opacity-90 rounded-2xl px-8 py-5 card-shadow border-2 border-green-200 relative">
                    <AnimalImg animal={trial.animal} size={100} className={featureAttached ? "anim-glow" : ""} />
                    <span className="fredoka text-2xl text-green-900 font-bold">{trial.animal.label}</span>
                    {/* Attached feature label */}
                    {featureAttached && (
                      <span className="absolute -bottom-3 left-1/2 -translate-x-1/2 px-3 py-1 rounded-full text-sm font-bold text-white anim-snap"
                        style={{ backgroundColor: trial.feature.color }}>
                        {trial.feature.label}!
                      </span>
                    )}
                  </div>
                </div>

                {/* Prompt */}
                <div className="text-center mb-5">
                  <span className="inline-block bg-amber-100 text-amber-800 px-5 py-2 rounded-2xl fredoka text-xl font-bold border-2 border-amber-200 card-shadow">
                    ğŸ” What do {trial.animal.label}s have?
                  </span>
                </div>

                {/* Feature options */}
                <div className="flex gap-4 justify-center flex-wrap mb-5">
                  {trial.options.map((feat, idx) => (
                    <FeatureButton key={idx} feature={feat} index={idx}
                      selected={selected === idx} feedback={feedback}
                      isCorrect={idx === trial.correctIndex}
                      disabled={feedback !== null} onClick={handleSelect} />
                  ))}
                </div>

                {/* Feedback */}
                {feedback && (
                  <div className={`text-center mb-4 py-3 px-6 rounded-2xl nunito font-bold text-lg mx-auto max-w-md anim-slideup
                    ${feedback === "correct" ? "bg-green-100 text-green-800 border-2 border-green-300" : "bg-amber-50 text-amber-800 border-2 border-amber-200"}`}>
                    {feedback === "correct"
                      ? [`${trial.animal.label}s have ${trial.feature.label}! ğŸ¯`, "That's it! âœ¨", "Snap! Feature found! ğŸ”"][Math.floor(Math.random()*3)]
                      : `Not quite â€” ${trial.animal.label}s have ${trial.feature.label}, not ${trial.options[selected]?.label}.`}
                  </div>
                )}
              </>
            )}

            {/* â”€â”€ TEST PHASE: C animal â†’ pick B animal â”€â”€ */}
            {isTest && (
              <>
                {/* Show C animal */}
                <div className="text-center mb-4 anim-slideup">
                  <div className="inline-flex flex-col items-center gap-2 bg-white bg-opacity-90 rounded-2xl px-8 py-5 card-shadow border-2 border-emerald-200">
                    <AnimalImg animal={trial.animalC} size={100} />
                    <span className="fredoka text-2xl text-green-900 font-bold">{trial.animalC.label}</span>
                  </div>
                </div>

                {/* Prompt */}
                <div className="text-center mb-5">
                  <span className="inline-block bg-emerald-100 text-emerald-800 px-5 py-2 rounded-2xl fredoka text-xl font-bold border-2 border-emerald-200 card-shadow">
                    ğŸ¤ What has something in common with {trial.animalC.label}?
                  </span>
                  <p className="text-xs text-emerald-600 nunito mt-1 opacity-70">Test â€” no hints</p>
                </div>

                {/* B animal options */}
                <div className="flex gap-4 sm:gap-6 justify-center flex-wrap mb-5">
                  {trial.options.map((animal, idx) => (
                    <AnimalCard key={idx} animal={animal} index={idx}
                      selected={selected === idx} feedback={null}
                      isCorrect={idx === trial.correctIndex}
                      disabled={feedback !== null} onClick={handleSelect} />
                  ))}
                </div>

                {/* Neutral acknowledgment */}
                {feedback && (
                  <div className="text-center mb-4 py-3 px-6 rounded-2xl nunito text-emerald-600 max-w-md mx-auto bg-emerald-50 border border-emerald-200 anim-slideup">
                    Response recorded.
                  </div>
                )}
              </>
            )}

            {/* Action button */}
            <div className="flex justify-center">
              {!feedback ? (
                <button onClick={handleSubmit} disabled={selected === null}
                  className={`px-8 py-4 rounded-2xl font-bold text-lg transition-all fredoka
                    ${selected === null
                      ? "bg-gray-300 text-gray-500 cursor-not-allowed"
                      : "bg-gradient-to-b from-green-400 to-green-600 text-white hover:from-green-300 hover:to-green-500 shadow-lg hover:scale-105 border-2 border-green-700"}`}>
                  {isTest ? "ğŸ¤ Match!" : "ğŸ” Check!"}
                </button>
              ) : (
                <button onClick={handleNext}
                  className="px-8 py-4 rounded-2xl font-bold text-lg bg-gradient-to-b from-emerald-400 to-emerald-600 text-white hover:from-emerald-300 hover:to-emerald-500 shadow-lg hover:scale-105 transition-all fredoka border-2 border-emerald-700">
                  {trialIndex + 1 < TRIALS_PER_PHASE ? "ğŸŒ¿ Next â†’" : "âœ¨ Finish Phase"}
                </button>
              )}
            </div>

            {/* Footer */}
            <div className="text-center mt-8 text-green-700 opacity-30 text-xs nunito">
              RFT Program 6 Â· Common Features Â· Syntopic Systems
              <br/>Emoji by <a href="https://openmoji.org" target="_blank" rel="noopener" className="underline">OpenMoji</a> (CC BY-SA 4.0)
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById("root")).render(<CommonFeatures />);
  </script>
</body>
</html>
